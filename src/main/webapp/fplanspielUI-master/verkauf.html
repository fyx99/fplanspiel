<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Verkauf</title>
    <script src="jquery/jquery-1.11.0.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">
    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
 </head>
 
 <body onload="start()">
 		<script type="text/javascript" >
 			$(document).ready(function() {
                $('#navbar').load('navbar.html');
                $('#footer').load('footer.html');
                });
 			
 			
 			window.onload = getDataVerkauf();
 			
 			var datenvMarkt;
 			var datenUnternehmen;
 			
 			function getDataVerkauf(){
 				
 				//Schnittstelle: Alle Maschinen und Mitarbeiter, die der Nutzer gekauft hat
 				jQuery.ajax({
 					url: "../api/spiel/unternehmen",
 					type: "GET",
 					dataType: "json",
 					success: function(data, data2){
 						datenUnternehmen = data;
 						console.log("datenUnternehmen funktioniert:"+datenUnternehmen.mitarbeiter.arbeiter);
 						printMaschinen(data.maschinen.maschinen);
 						printMitarbeiter(data.mitarbeiter.arbeiter);
 					}
 				});
 			
 				//Schnittstelle: Alle Produzierten Produkte
 				jQuery.ajax({
 					url: "../api/spiel/unternehmen",
 					type: "GET",
 					dataType: "json",
 					success: function(data, data2){
 						printBestandP(data);
 						
 					}
 				});
 				
 				//Schnittstelle: Alle Angebote, die der Nutzer erstellt hat
 				jQuery.ajax({
 					url: "../api/spiel/vmarkt",
 					type: "GET",
 					dataType: "json",
 					success: function(data, data2){
 						datenvMarkt = data;
 						printAngebote(data.angebote);
 					}
 				});
 			
 				
 			}
 			
 			 			
 			//Neues Objekt Dictionary (Speichert später alle produzierten Produkte)
 			var dict = {};
 			
 			var mengeProdukte = {};
 			
 			
 			/* 
 			 * function printBestandP()
 			 * */
 			function printBestandP(data){
 				
 				var kapAlleArbeiter = data.mitarbeiter.kapazitaeten;
 				data = data.produkte;
 				
 				var cont  = document.getElementById('contentBestandP');
 				var contSel = document.getElementById('contentSelect');
 				var contSel2 = document.getElementById('contentSelect2');
 				var s1 ="";
 				var s2 ="";
 				var s3 ="";
 				
 				for(var produkt in data){
 					s1 += 	'<li class="list-group-item">'+ data[produkt].p.name+
 								'<span class="badge">'+
 								 data[produkt].menge+
 								'</span>'+
 							'</li>';
 							
 					s2 += '<option>'+data[produkt].p.name+'</option>';
 					
 					s3 += '<p>'+kapAlleArbeiter.VERTRIEB+'</p>';
 					
 					// Speichere in das Dictionary den Name des Produktes als Key und die Id des Produktes als Wert
 					dict[ data[produkt].p.name ] = data[produkt].p.id;
 					mengeProdukte[ data[produkt].p.name ] = data[produkt].menge;
 					
 					
 				}
 				
 				cont.innerHTML = s1;
 				contSel.innerHTML = s2;
 				contSel2.innerHTML = s3;
 			}
 			
 			var alleAngebote = {};
 			
 			/* 
 			 * function printAngebote()
 			 * */
 			function printAngebote(data) {
 				var cont = document.getElementById('contentAngebote');
 				var s ="";
 				var angebotsid;
 				for(var angebot in data){
 					angebotsid = data[angebot].id;
 					
 					//Speichere alle Angebote mit Key Produktname und Wert Anzahl
 					alleAngebote[data[angebot].markteinheit.name] = data[angebot].menge;
 					
 					s += '<div class="col-sm-6 col-md-4"><div class="thumbnail">'+
						
						'<div class="caption">'+
							'<div class="col-sm-12">'+
								'<h4>Angebot '+angebotsid+'</h4>'+
							'</div>'+
							'<br>'+
							'<div class="col-sm-6">'+
								'<p>'+data[angebot].markteinheit.name+'</p>'+
							'</div>'+
							'<div class="col-sm-3">'+
								'<p>'+ data[angebot].menge+'</p>'+
							'</div>'+
							'<div class="col-sm-3">'+
								'<p>Stück</p>'+
							'</div>'+
										
							'<div class="col-sm-6">'+
								'<p>Preis</p>'+
							'</div>'+
							'<div class="col-sm-3">'+
								'<p>'+ data[angebot].preis+'</p>'+
							'</div>'+
							'<div class="col-sm-3">'+
								'<p>€</p>'+
							'</div>'+
							
							'<div class="col-sm-6">'+
							'</div>'+
							'<div class="col-sm-6">'+
								'<button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#modalVerkauf" onClick="angebotEntfernenModal('+angebotsid+',0)">Angebot entfernen</button>'+
								'<br>'+
							'</div>'+
							'<div class="row"></div>'+
						'</div>' + 
 						'</div></div></div>';
 				}
 				cont.innerHTML = s;
 			}
 			
 			

 			/* 
 			 * function printMaschinen()
 			 * */
 			function printMaschinen(data){
 				var cont = document.getElementById('contentVKMaschinen');
 				var s ="";
 				var maschinenid;
 				for(var maschine in data){
 					maschinenid = data[maschine].id;
 					s += '<div class="col-sm-6 col-md-4"><div class="thumbnail">'+
						
						'<div class="caption">'+
							'<div class="col-sm-12">'+
								'<h4>'+data[maschine].name+'  '+maschinenid+'</h4>'+
							'</div>'+
							'<br>'+
								
							'<div class="col-sm-6">'+
								'<p>Kapazität</p>'+
							'</div>'+
							'<div class="col-sm-6">'+
								'<p>'+ data[maschine].kapazitaet+'</p>'+
							'</div>'+
							
							'<div class="col-sm-6">'+
								'<p>Auslastung:</p>'+
							'</div>'+
							'<div class="col-sm-6">'+
								'<p>'+data[maschine].auslastung+'</p>'+
							'</div>'+
							
							'<div class="col-sm-8">'+
							'</div>'+
							'<div class="col-sm-4">'+
								'<button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#modalVerkauf" onClick="angebotEntfernenModal('+maschinenid+',1)">Verkaufen</button>'+
								'<br>'+
							'</div>'+
							'<div class="row"></div>'+
						'</div>' + 
 						'</div></div></div>';
 				}
 				cont.innerHTML = s;
 			}
 			
 			

 			/* 
 			 * function printMitarbeiter()
 			 * */
 			function printMitarbeiter(data){
 				var cont = document.getElementById('contentVKMitarbeiter');
 				var s ="";
 				var maschinenid;
 				for(var arbeiter in data){
 					arbeiterid = data[arbeiter].m.id;
 					s += '<div class="col-sm-6 col-md-4"><div class="thumbnail">'+
						
						'<div class="caption">'+
							'<div class="col-sm-12">'+
								'<h4>'+data[arbeiter].m.name+'</h4>'+
							'</div>'+
							'<br>'+
							'<div class="col-sm-6">'+
								'<p>Fachgebiet</p>'+
							'</div>'+
							'<div class="col-sm-6">'+
								'<p>'+ data[arbeiter].m.mfg+'</p>'+
							'</div>'+
							'<div class="col-sm-6">'+
								'<p>Arbeitszeit:</p>'+
							'</div>'+
							'<div class="col-sm-6">'+
								'<p>'+data[arbeiter].m.arbeitszeit+'</p>'+
							'</div>'+
							'<div class="col-sm-6">'+
								'<p>Auslastung:</p>'+
							'</div>'+
							'<div class="col-sm-6">'+
								'<p>'+data[arbeiter].auslastung+'</p>'+
							'</div>'+
							
							'<div class="col-sm-8">'+
							'</div>'+
							'<div class="col-sm-4">'+
								'<button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#modalVerkauf" onClick="angebotEntfernenModal('+arbeiterid+',2)">Kündigen</button>'+
								'<br>'+
							'</div>'+
							'<div class="row"></div>'+
						'</div>' + 
 						'</div></div></div>';
 				}
 				cont.innerHTML = s;
 			}
 			
 			
 			
 			/* 
 			 * function anbieten()
 			 * */
 			function anbieten() {
 				
 				//Anzahl an Zeit, die von einem Mitarbeiter für 1 Angebot verbraucht wird
 				var verbrauchZeit = 3;
 				
 				var menge = document.getElementById("inputMenge").value;
 				var preis = document.getElementById("inputPreis").value;
 				var meldung  = document.getElementById('label');
 				
 				//Auslesen des Optionsfelds für Produkte
 				var optionField =  document.getElementById("contentSelect");
 				var sIndex = optionField.selectedIndex; //Startet bei 0
 				var produktName = optionField.options[sIndex].text;
 				
 				
 				
 				var produktid = dict[produktName];
 				
 				// Prüfen, ob ein neues Angebot für dieses Produkt zulässig ist (abhängig von der Menge)
 				var zulaessig = mengeProdukte[produktName]-alleAngebote[produktName];
 				if(zulaessig <= 0){
 					console.log("Ausgabe Fehlermeldung1");
 	 			        var text = "<h6>&nbsp;&nbsp;Ungültige Eingabe!</h6>";
 	 			        meldung.innerHTML = text;
 	 			      	return;
 					}
 				
 				// Prüfe ob eine positive Zahl eigegeben wurde
 				if (isNaN(menge) || isNaN(preis) || menge < 1 ){
 					console.log("Ausgabe Fehlermeldung2");
 			        var text = "<h6>&nbsp;&nbsp;Ungültige Eingabe!</h6>";
 			        meldung.innerHTML = text;
 			        return;
 				}
 				
 				if(datenUnternehmen.mitarbeiter.kapazitaeten.VERTRIEB <= 0){
 					text = "<h6>&nbsp;&nbsp;Nicht genug Arbeitszeit!</h6><h6><b>&nbsp;&nbsp;Ein Angebot verbraucht 2 h!</b></h6>";
					 meldung.innerHTML = text;
 			        return;
 				}
 				
 				/* //*** 2. Prüfe, ob ein Mitarbeiter des Vertriebs mit genug Kapazität vorhanden ist ***
 		 		var optionFieldM =  document.getElementById("contentSelect2"); //Auslesen der Optionsfelder
 		 		var anzOptionen =  document.getElementById("contentSelect2").length; // Anzahl der Optionen im Select
 		 		
 		 		// Wenn mind. 1 Mitarbeiter vorhanden
 		 		if(anzOptionen > 0){
 			 		var iIndex = optionFieldM.selectedIndex; //Startet bei 0
 			 	    var inhalt = optionFieldM.options[sIndex].text; //Inhalt des Optionsfeldes: 38 Holzstuhlmaschine (0/100)
 			 		var parts = inhalt.split(" ");	// String bei den Leerzeichen aufsplitten
 			 		
 			 		var mitarbeiterid = dictArbeiter[parts[0]];
 			 		
 			 	    
 			 	    //Prüfe, ob die ausgewählte Maschine genug Kapazität hat oder ausgelastet ist
 			 	    for(arbeiter in datenUnternehmen.mitarbeiter.arbeiter){
 			 	    	
 							var auslastung = [arbeiter].auslastung;
 							var kapazitaet = datenUnternehmen.mitarbeiter.arbeiter[arbeiter].m.arbeitszeit;
 							var rechnung = kapazitaet - auslastung - verbrauchZeit;
 							if(rechnung < 0){
 								text = "<b>&nbsp;&nbsp; Nicht genug Arbeitszeit!</b><b>&nbsp;&nbsp; Ein Angebot verbraucht 3 Stunden !</b>";
 								 meldung.innerHTML = text;
 			 			        return;
 							}else{
 								text = "";
 							}
 						
 			 	    }
 			 	   
 			 	} else{
 			 		text = "<b>&nbsp;&nbsp; Für das Einstellen eines Angebots wird ein Mitarbeiter des Vertriebs benötigt!</b>";
 			 		 meldung.innerHTML = text;
  			        return;
 			 	} */
 				
 				var text = "";
			    meldung.innerHTML = text;
			    
			    // Wenn alle Angaben überprüft wurden -> Erstelle ein neues Angebot!
 				jQuery.ajax({
 					url: "../api/spiel/anbieten?menge=" + menge + "&produktid=" + produktid + "&preis=" + preis,
 					type: "GET",
 					dataType: "json",
 					success: function(data, data2){
 						getDataVerkauf();
 					}
 				});
 			
 			}
 			
 			
 			/* 
 			 * function angebotEntfernenModal()
 			 * */
 			function angebotEntfernenModal(id,index) {
 				var cont  = document.getElementById('contentModalVerk');
 				var text;
 				var func;
 				
 				if(index == 0) {
 					name = "Angebot "+id;
 					text = "Möchten Sie das Angebot wirklich entfernen?";
 					func = "angebotEntfernen("+id;
 				}
 				
 				if(index == 1) {
 					name = "Maschine "+id;
 					text = "Möchten Sie die Maschine wirklich verkaufen?";
 					// func = maschineVerkaufen(....)
 					return;
 				}
 				
 				if(index == 2) {
 					name = "Mitarbeiter "+id;
 					text = "Möchten Sie dem Mitarbeiter wirklich kündigen?";
 					// func = mitarbeiterKuendigen(...)
 					return;
 				}
 				
 				var s ='<div class="col-sm-12">'+
				'<h3>'+name+'</h3><div><br></div>'+
				'</div>'+
				'<div class="col-sm-12">'+
					'<h4>'+text+'</h4>'+
				'</div>'+
				
				'<div class="row">'+
					'<div class="col-sm-9">'+
					'</div>'+
					'<div class="col-sm-3">'+
						'<button type="button" class="btn btn-danger" data-dismiss="modal" onClick="'+func+')">Bestätigen</button>'+
					'</div>'+
				'</div>';
				
				cont.innerHTML = s;
			
 			}
 			
 			
 			
 			/* 
 			 * function angebotEntfernen()
 			 * */
 			function angebotEntfernen(angebotsid) {
 				jQuery.ajax({
 					url: "../api/spiel/angebotentfernen?id=" + angebotsid,
 					type: "GET",
 					dataType: "json",
 					success: function(data, data2){
 						
 						console.log("Angebot entfernt");
 					}
 				});
 				
 				$('#navbar').load('navbar.html');
 				getDataVerkauf();
 			}
 			 

		</script>

    <!-- Fixed navbar -->
    <div id="navbar">
	</div>
    
	<!-- Page Header -->
	<div class="container">	
        <div class="page-header">
            <h1>Verkauf</h1>
        </div>
        
        <div class="page-header">
            <h2>Angebote</h2>
        </div>
		
		<!-- Sprungmarke für Navigation -->
  		<div id="angebotNeu"></div>
  		<br>
  		<br>
  		
		<div>
			<div class="col-sm-6"><h3>Bestand an Produkten:</h3></div>
			<div class="col-sm-6"><h3>Angebote einstellen:</h3></div>
		</div>
		
		
		<div class="row"><br></div>
		<div class="well">
		<!-- Liste des Produktbestandes -->
		<div class="row">
				<ul class="list-group col-sm-4" id = "contentBestandP">
				
				</ul> 
			<div class="col-sm-2 align-self-center"></div>
			<div class="col-sm-4 align-self-center">
				<div class="row">
				 	<div class="form-group">
				 
				 		<div class="col-sm-5 align-self-center">
  							  <label for="sel1">Produkt:</label>
  						</div>
  						<div class="col-sm-7 align-self-center">
  							 <select class="form-control" id="contentSelect">
							  
							  </select>
  						</div>
  						
					</div> 
				</div>
				
				<div class="row">
					<div class="form-group">
	  						<div class="col-sm-5 align-self-center">
	  							<label>Menge:</label>
	  						</div>
	  						<div class="col-sm-7 align-self-center">
	  							<input type="text" class="form-control" id="inputMenge">
	  						</div>
					</div>
				</div>
				
				<div class="row">
					<div class="form-group">
	  						<div class="col-sm-5 align-self-center">
	  							<label>Preis:</label>
	  						</div>
	  						<div class="col-sm-7 align-self-center">
	  							<input type="text" class="form-control" id="inputPreis">
	  						</div>
					</div>
				</div>
				
				<div class="row">
					<div class="form-group">
	  						<div class="col-sm-6 align-self-center">
	  							<label>Vorhandene</label>
	  							<label>Arbeitszeit Vertrieb:</label>
	  							 
	  						</div>
	  						<div class="col-sm-6 align-self-center">
	  							<br>
	  							<label id="contentSelect2"></label>
	  						</div>
					</div>
				</div>
				
				<div class="row">
					<div class ="col-sm-6"></div>
					<div class ="col-sm-6">
						<div class="form-group">
		  						<label id="label"></label>
						</div>
					</div>
				</div>
				
				
 				
			</div>
			<div class="col-sm-1 align-self-center"></div>
			<div class="col-sm-2 align-self-end">
				<button type="button" class="btn btn-sm" onClick="anbieten()">Neues Angebot einstellen</button>
			</div>
		</div>
		
		</div>
		
		<!-- Sprungmarke für Navigation -->
  		<div id="angebote"></div>
  		<br>
  		<br>
  		
		<!-- Bestehende Angebote -->
		<br>
		<div>
			<h3>Bestehende Angebote:</h3>
		</div>
		
		 <div class="well">
        		<div class="row" id="contentAngebote">
  				</div>
  		</div>
  		
  		<!-- Sprungmarke für Navigation -->
  		<div id="maschinen"></div>
  		<br>
  		<br>
  		
  		<div class="page-header">
            <h2>Verkauf von Maschinen</h2>
        </div>
        
        <div class="well">
        		<div class="row" id="contentVKMaschinen">
  				</div>
  		</div>
  		
  		<!-- Sprungmarke für Navigation -->
  		<div id="mitarbeiter"></div>
  		<br>
  		<br>
  		
  		<div class="page-header">
            <h2>Kündigen von Mitarbeitern</h2>
        </div>
        
        <div class="well">
        		<div class="row" id="contentVKMitarbeiter">
  				</div>
  		</div>
	</div>
	
	<!-- The Modal -->
  <div class="modal" id="modalVerkauf">
    <div class="modal-dialog">
      <div class="modal-content">
      
        <!-- Modal Header -->
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        
         <div class="modal-body" id="contentModalVerk">
          </div>
       
        
      </div>
    </div>
  </div>

    <!-- Fixed footer -->
    <div id="footer">
	</div>

  </body>
</html>